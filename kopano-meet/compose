version: "2.0"

services:
  web:
    image: fbartels/kopano_web:latest
    container_name: kopano_web
    restart: always
    ports:
      - "2015:2015"
    environment:
      - EMAIL=off
      - FQDN=@%@hostname@%@.@%@domainname@%@
      - DEFAULTREDIRECT=/meet
    command: wrapper.sh
    cap_drop:
     - ALL
    cap_add:
     - NET_BIND_SERVICE
     - CHOWN
     - SETGID
     - SETUID
    volumes:
     - /etc/ssl/certs:/etc/ssl/certs:ro
    networks:
     - web-net

  kopano_ssl:
    image: fbartels/kopano_ssl:latest
    container_name: kopano_ssl
    environment:
      - FQDN=@%@hostname@%@.@%@domainname@%@
      - PKI_COUNTRY=DE
    volumes:
      - /etc/kopano/docker/:/kopano/ssl

  kopano_konnect:
    image: fbartels/kopano_konnect:latest
    container_name: kopano_konnect
    depends_on:
      - kopano_ssl
      - web
    volumes:
      - /etc/kopano/docker/:/kopano/ssl
      - /var/lib/univention-appcenter/apps/kopano-meet/machine.secret:/etc/machine.secret
      - /etc/ssl/certs:/etc/ssl/certs:ro
    environment:
      - FQDN=@%@hostname@%@.@%@domainname@%@
      - ecparam=/kopano/ssl/ecparam.pem
      - eckey=/kopano/ssl/meet-kwmserver.pem
      - signing_private_key=/kopano/ssl/konnectd-tokens-signing-key.pem
      - encryption_secret_key=/kopano/ssl/konnectd-encryption.key
      - identifier_registration_conf=/kopano/ssl/konnectd-identifier-registration.yaml
      - identifier_scopes_conf=/etc/kopano/konnectd-identifier-scopes.yaml
      - allow_client_guests=yes
      - allow_dynamic_client_registration=yes
      - uri_base_path=/kopanoid
      - KONNECT_BACKEND=ldap
      - INSECURE=yes
      - LDAP_URI=ldap://@%@ldap/server/name@%@:@%@ldap/server/port@%@
      - LDAP_BINDDN=@%@appcenter/apps/kopano-meet/hostdn@%@
      - LDAP_BINDPW_FILE=/etc/machine.secret
      - LDAP_BASEDN==@%@ldap/base@%@
      - LDAP_SCOPE=sub
      - LDAP_LOGIN_ATTRIBUTE=uid
      - LDAP_EMAIL_ATTRIBUTE=mail
      - LDAP_NAME_ATTRIBUTE=cn
      - LDAP_UUID_ATTRIBUTE=uidNumber
      - LDAP_UUID_ATTRIBUTE_TYPE=text
      - LDAP_FILTER=(objectClass=organizationalPerson)
    networks:
      - kopano-net
      - web-net

  kopano_grapi:
    image: fbartels/kopano_core:latest
    container_name: kopano_grapi
    volumes:
      - /run/kopano:/run/kopano
      - /var/lib/univention-appcenter/apps/kopano-meet/machine.secret:/etc/machine.secret
      - /etc/ssl/certs:/etc/ssl/certs:ro
    environment:
      - SERVICE_TO_START=grapi
      - TZ=Europe/Berlin
      - ADDITIONAL_KOPANO_PACKAGES=python3-grapi.backend.ldap
      - GRAPI_BACKEND=ldap
      - KCCONF_GRAPI_LDAP_URI=ldap://@%@ldap/server/name@%@:@%@ldap/server/port@%@
      - KCCONF_GRAPI_LDAP_BINDDN=@%@appcenter/apps/kopano-meet/hostdn@%@
      - KCCONF_GRAPI_LDAP_BINDPW_FILE=/etc/machine.secret
      - KCCONF_GRAPI_LDAP_BASEDN=@%@ldap/base@%@
    networks:
      - kopano-net

  kopano_kapi:
    image: fbartels/kopano_core:latest
    container_name: kopano_kapi
    depends_on:
      - kopano_grapi
    volumes:
      - /etc/kopano/docker/:/kopano/ssl
      - /run/kopano:/run/kopano
      - /etc/ssl/certs:/etc/ssl/certs:ro
    environment:
      - SERVICE_TO_START=kapi
      - TZ=Europe/Berlin
      - KCCONF_KAPID_LOG_LEVEL=DEBUG
      - KCCONF_KAPID_OIDC_ISSUER_IDENTIFIER=https://@%@hostname@%@.@%@domainname@%@/kopanoid
      - KCCONF_KAPID_INSECURE=yes
    networks:
      - kopano-net
      - web-net

  kopano_kwmserver:
    image: fbartels/kopano_kwmserver:latest
    container_name: kopano_kwmserver
    command: wrapper.sh
    environment:
     - INSECURE=yes
     - oidc_issuer_identifier=https://@%@hostname@%@.@%@domainname@%@/kopanoid
     - enable_guest_api=yes
     - public_guest_access_regexp=^group/public/.*
    volumes:
      - /etc/kopano/docker/:/kopano/ssl
      - /etc/ssl/certs:/etc/ssl/certs:ro
    networks:
     - web-net

  kopano_meet:
    image: fbartels/kopano_meet:1.1.1_0
    container_name: kopano_meet
    environment:
     - SERVICE_TO_START=meet
     - KCCONF_KWEBD_TLS=no
     - KCCONF_MEET_oidc_iss=https://@%@hostname@%@.@%@domainname@%@/kopanoid
     - KCCONF_MEET_guests_enabled=true
     - KCCONF_MEET_disableFullGAB=false
     - KCCONF_MEET_useIdentifiedUser=true
    volumes:
     - /etc/ssl/certs:/etc/ssl/certs:ro
    depends_on:
     - kopano_kapi
     - kopano_kwmserver
     - web
    networks:
     - web-net

networks:
  web-net:
  kopano-net:
    driver: bridge
