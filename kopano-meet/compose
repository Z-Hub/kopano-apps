version: "2.0"

services:
  web:
    image: fbartels/kopano_web:0.8.3
    container_name: kopano_web
    restart: always
    ports:
      - "2015:2015"
    environment:
      - DEFAULTREDIRECT=/meet
      - EMAIL=off
      - FQDN=@%@hostname@%@.@%@domainname@%@
    command: wrapper.sh
    cap_drop:
     - ALL
    cap_add:
     - CHOWN
     - NET_BIND_SERVICE
     - SETGID
     - SETUID
    volumes:
     - /etc/ssl/certs:/etc/ssl/certs:ro
    networks:
     - web-net

  kopano_ssl:
    image: fbartels/kopano_ssl:1.2.0
    container_name: kopano_ssl
    environment:
      - FQDN=@%@hostname@%@.@%@domainname@%@
      - PKI_COUNTRY=DE
    volumes:
      - /etc/kopano/docker/:/kopano/ssl

  kopano_konnect:
    image: fbartels/kopano_konnect:0.26.0
    container_name: kopano_konnect
    restart: always
    depends_on:
      - kopano_ssl
      - web
    volumes:
      - /etc/kopano/docker/:/kopano/ssl
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /var/lib/univention-appcenter/apps/kopano-meet/machine.secret:/etc/machine.secret
    environment:
      - allow_client_guests=yes
      - allow_dynamic_client_registration=yes
      - eckey=/kopano/ssl/meet-kwmserver.pem
      - ecparam=/kopano/ssl/ecparam.pem
      - encryption_secret_key=/kopano/ssl/konnectd-encryption.key
      - external_oidc_clientsecret=${clientsecret}
      - external_oidc_name=ucs-konnect
      - external_oidc_provider=yes
      - external_oidc_url=https://@%@ucs/server/sso/fqdn@%@
      - FQDN=@%@hostname@%@.@%@domainname@%@/kopanoid
      - identifier_registration_conf=/kopano/ssl/konnectd-identifier-registration.yaml
      - identifier_scopes_conf=/etc/kopano/konnectd-identifier-scopes.yaml
      - insecure=${INSECURE}
      - KONNECT_BACKEND=ldap
      - LDAP_BASEDN=@%@ldap/base@%@
      - LDAP_BINDDN=@%@appcenter/apps/kopano-meet/hostdn@%@
      - LDAP_BINDPW_FILE=/etc/machine.secret
      - LDAP_EMAIL_ATTRIBUTE=mail
      - LDAP_FILTER=(objectClass=organizationalPerson)
      - LDAP_LOGIN_ATTRIBUTE=uid
      - LDAP_NAME_ATTRIBUTE=cn
      - LDAP_SCOPE=sub
      - LDAP_URI=ldap://@%@ldap/server/name@%@:@%@ldap/server/port@%@
      - LDAP_UUID_ATTRIBUTE_TYPE=text
      - LDAP_UUID_ATTRIBUTE=uidNumber
      - signing_private_key=/kopano/ssl/konnectd-tokens-signing-key.pem
      - uri_base_path=/kopanoid
    networks:
      - kopano-net
      - web-net

  kopano_grapi:
    image: fbartels/kopano_core:8.7.85.0.f3999a9
    container_name: kopano_grapi
    restart: always
    volumes:
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /run/kopano:/run/kopano
      - /var/lib/kopano-grapi:/var/lib/kopano-grapi
      - /var/lib/univention-appcenter/apps/kopano-meet/machine.secret:/etc/machine.secret
    environment:
      - GRAPI_BACKEND=ldap
      - KCCONF_GRAPI_LDAP_BASEDN=@%@ldap/base@%@
      - KCCONF_GRAPI_LDAP_BINDDN=@%@appcenter/apps/kopano-meet/hostdn@%@
      - KCCONF_GRAPI_LDAP_BINDPW_FILE=/etc/machine.secret
      - KCCONF_GRAPI_LDAP_URI=ldap://@%@ldap/server/name@%@:@%@ldap/server/port@%@
      - SERVICE_TO_START=grapi
      - TZ=Europe/Berlin
    networks:
      - kopano-net

  kopano_kapi:
    image: fbartels/kopano_core:8.7.85.0.f3999a9
    container_name: kopano_kapi
    restart: always
    depends_on:
      - kopano_grapi
    volumes:
      - /etc/kopano/docker/:/kopano/ssl
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /run/kopano:/run/kopano
    environment:
      - KCCONF_KAPID_INSECURE=${INSECURE}
      - KCCONF_KAPID_LOG_LEVEL=DEBUG
      - KCCONF_KAPID_OIDC_ISSUER_IDENTIFIER=https://@%@hostname@%@.@%@domainname@%@/kopanoid
      - SERVICE_TO_START=kapi
      - TZ=Europe/Berlin
    networks:
      - kopano-net
      - web-net

  kopano_kwmserver:
    image: fbartels/kopano_kwmserver:1.0.0
    container_name: kopano_kwmserver
    restart: always
    command: wrapper.sh
    environment:
     - enable_guest_api=${MEET_GUEST_ALLOW}
     - INSECURE=${INSECURE}
     - oidc_issuer_identifier=https://@%@hostname@%@.@%@domainname@%@/kopanoid
     - public_guest_access_regexp=${MEET_GUEST_REGEXP}
     - turn_service_credentials_password=${TURN_PASSWORD}
     - turn_service_credentials_user=${TURN_USER}
    volumes:
      - /etc/kopano/docker/:/kopano/ssl
      - /etc/ssl/certs:/etc/ssl/certs:ro
    networks:
     - web-net

  kopano_meet:
    image: fbartels/kopano_meet:1.1.2_0
    container_name: kopano_meet
    restart: always
    environment:
     - GRID_WEBAPP=${GRID_WEBAPP}
     - KCCONF_KWEBD_TLS=no
     - KCCONF_MEET_disableFullGAB=false
     - KCCONF_MEET_guests_enabled=true
     - KCCONF_MEET_oidc_iss=https://@%@hostname@%@.@%@domainname@%@/kopanoid
     - KCCONF_MEET_useIdentifiedUser=true
     - SERVICE_TO_START=meet
    volumes:
     - /etc/ssl/certs:/etc/ssl/certs:ro
    depends_on:
     - kopano_kapi
     - kopano_kwmserver
     - web
    networks:
     - web-net

networks:
  web-net:
  kopano-net:
    driver: bridge
