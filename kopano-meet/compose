version: "2.0"

services:
  web:
    image: fbartels/kopano_web:latest
    container_name: kopano_web
    restart: always
    ports:
      - "2015:2015"
    environment:
      - EMAIL=off
      - FQDN=@%@hostname@%@.@%@domainname@%@
    command: wrapper.sh
    cap_drop:
     - ALL
    cap_add:
     - NET_BIND_SERVICE
     - CHOWN
     - SETGID
     - SETUID
    networks:
     - web-net

  kopano_ssl:
    image: fbartels/kopano_ssl:latest
    container_name: kopano_ssl
    environment:
      - FQDN=@%@hostname@%@.@%@domainname@%@
      - PKI_COUNTRY=DE
    volumes:
      - /etc/kopano/ssl/:/kopano/ssl

  kopano_grapi:
    image: fbartels/kopano_core:latest
    container_name: kopano_grapi
    volumes:
      - /run/kopano:/run/kopano
      - /var/lib/univention-appcenter/apps/kopano-meet/machine.secret:/etc/machine.secret
    environment:
      - SERVICE_TO_START=grapi
      - TZ=Europe/Berlin
      - ADDITIONAL_KOPANO_PACKAGES=python3-grapi.backend.ldap
      - KCCONF_GRAPI_BACKEND=ldap
      - KCCONF_GRAPI_LDAP_URI=ldap://@%@ldap/server/name@%@:@%@ldap/server/port@%@
      - KCCONF_GRAPI_LDAP_BINDDN=@%@appcenter/apps/kopano-meet/hostdn@%@
      - KCCONF_GRAPI_LDAP_BINDPW_FILE=/etc/machine.secret
      - KCCONF_GRAPI_LDAP_BASEDN=@%@ldap/base@%@
    networks:
      - kopano-net

  kopano_kapi:
    image: fbartels/kopano_core:latest
    container_name: kopano_kapi
    depends_on:
      - kopano_grapi
    volumes:
      - /etc/kopano/ssl:/kopano/ssl
      - /run/kopano:/run/kopano
    environment:
      - SERVICE_TO_START=kapi
      - TZ=Europe/Berlin
      - KCCONF_KAPID_LOG_LEVEL=DEBUG
      - KCCONF_KAPID_OIDC_ISSUER_IDENTIFIER=https://@%@ucs/server/sso/fqdn@%@
      - KCCONF_KAPID_INSECURE=yes
    networks:
      - kopano-net
      - web-net

  kopano_kwmserver:
    image: fbartels/kopano_kwmserver:latest
    container_name: kopano_kwmserver
    command: wrapper.sh
    environment:
     - INSECURE=yes
     - oidc_issuer_identifier=https://@%@ucs/server/sso/fqdn@%@
    volumes:
      - /etc/kopano/ssl:/kopano/ssl
    networks:
     - web-net

  kopano_meet:
    image: fbartels/kopano_meet:0.22.1_0
    container_name: kopano_meet
    environment:
     - SERVICE_TO_START=meet
     - KCCONF_KWEBD_TLS=no
     - KCCONF_MEET_oidc_iss=https://@%@ucs/server/sso/fqdn@%@
     - KCCONF_MEET_guests_enabled=true
     - KCCONF_MEET_disableFullGAB=false
    depends_on:
     - kopano_kapi
     - kopano_kwmserver
     - web
    networks:
     - web-net

networks:
  web-net:
  kopano-net:
    driver: bridge
