#!/bin/bash

set -x

VERSION=1
SERVICE="Kopano-Konnect"

. /usr/share/univention-join/joinscripthelper.lib
. /usr/share/univention-appcenter/joinscripthelper.sh
. /usr/share/univention-lib/ldap.sh
. /usr/share/univention-lib/base.sh

joinscript_init
eval "$(ucr shell)"

CONFIG="$(joinscript_container_file /etc/univention/base.conf)"

ucs_addServiceToLocalhost "${SERVICE}" "$@"

a2enmod rewrite proxy proxy_http

cat <<-EOF >"/etc/apache2/ucs-sites.conf.d/kopano-konnect.conf"
#####################################################################
# generated by Kopano-Konnect app join script, do not edit manually #
#####################################################################

# Kopano Konnect OIDC
ProxyPass /.well-known/openid-configuration http://localhost:8777/.well-known/openid-configuration retry=0
ProxyPass /konnect/v1/jwks.json http://localhost:8777/konnect/v1/jwks.json retry=0
ProxyPass /konnect/v1/session http://localhost:8777//konnect/v1/session retry=0
ProxyPass /konnect/v1/static http://localhost:8777/konnect/v1/static retry=0
ProxyPass /konnect/v1/token http://localhost:8777/konnect/v1/token retry=0
ProxyPass /konnect/v1/userinfo http://localhost:8777/konnect/v1/userinfo retry=0

# Kopano Konnect login area
ProxyPass /signin/ http://localhost:8777/signin/ retry=0
EOF

invoke-rc.d apache2 reload

joinscript_save_current_version
exit 0
