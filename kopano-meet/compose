version: "2.0"

services:
  web:
    image: zokradonh/kopano_web:latest
    container_name: web
    restart: always
    ports:
      - "2015:2015"
    environment:
      - EMAIL=off
      - FQDN=ec2-18-202-30-87.eu-west-1.compute.amazonaws.com
    command: wrapper.sh
    cap_drop:
     - ALL
    cap_add:
     - NET_BIND_SERVICE
     - CHOWN
     - SETGID
     - SETUID
    networks:
      web-net:
        aliases:
         - ec2-18-202-30-87.eu-west-1.compute.amazonaws.com

  kopano_ssl:
    image: zokradonh/kopano_ssl:latest
    container_name: kopano_ssl
    environment:
      - FQDN=ec2-18-202-30-87.eu-west-1.compute.amazonaws.com
      - PKI_COUNTRY=DE
    volumes:
      - /etc/kopano/ssl/:/kopano/ssl

  kopano_grapi:
    image: zokradonh/kopano_core:latest
    container_name: kopano_grapi
    volumes:
      - /run/kopano:/run/kopano
    environment:
      - SERVICE_TO_START=grapi
      - TZ=Europe/Berlin
    networks:
      - kopano-net

  kopano_kapi:
    image: zokradonh/kopano_core:latest
    container_name: kopano_kapi
    depends_on:
      - kopano_grapi
    volumes:
      - /etc/kopano/ssl:/kopano/ssl
      - /run/kopano:/run/kopano
    environment:
      - SERVICE_TO_START=kapid
      - TZ=Europe/Berlin
      - KCCONF_KAPID_LOG_LEVEL=DEBUG
      - KCCONF_KAPID_OIDC_ISSUER_IDENTIFIER=https://ec2-18-202-30-87.eu-west-1.compute.amazonaws.com
      - KCCONF_KAPID_INSECURE=false
    networks:
      - kopano-net
      - web-net

  kopano_konnect:
    image: zokradonh/kopano_konnect:latest
    container_name: kopano_konnect
    command: wrapper.sh
    volumes:
      - /etc/kopano/ssl:/kopano/ssl
      - /run/kopano:/run/kopano
    environment:
     - FQDN=ec2-18-202-30-87.eu-west-1.compute.amazonaws.com
    networks:
     - web-net

  kopano_kwmserver:
    image: zokradonh/kopano_kwmserver:latest
    container_name: kopano_kwmserver
    command: wrapper.sh
    environment:
     - INSECURE=false
     - oidc_issuer_identifier=https://ec2-18-202-30-87.eu-west-1.compute.amazonaws.com
    volumes:
      - /etc/kopano/ssl:/kopano/ssl
    networks:
     - web-net

  kopano_meet:
    image: zokradonh/kopano_meet:0.20.0
    container_name: kopano_meet
    environment:
     - SERVICE_TO_START=meet
     - KCCONF_KWEBD_TLS=no
    depends_on:
     - kopano_kapi
     - kopano_konnect
     - kopano_kwmserver
     - web
    networks:
     - web-net

networks:
  web-net:
  kopano-net:
    driver: bridge
