/*!
 * Copyright (c) 2018 Kopano
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 * 
 * @version 0.2.0 (2018-07-25T10:02:08Z) ES5
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("Pubs",[],t):"object"==typeof exports?exports.Pubs=t():e.Pubs=t()}(window,function(){return function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/umd/",n(n.s=1)}([function(e,t,n){"use strict";n.r(t);var o=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),r=function(){function e(e){this.target=e}return e.getName=function(){return this.eventName},e.eventName="PubsBaseEvent",e}(),c=function(e){function t(t){var n=e.call(this,t)||this;return n.connecting=t.connecting,n.connected=t.connected,n.reconnecting=t.reconnecting,n}return o(t,e),t.eventName="PubsStateChangedEvent",t}(r),i=function(e){function t(t,n,o){var r=e.call(this,t)||this;return r.data=n,r.info=o,r}return o(t,e),t.eventName="PubsStreamEvent",t}(r),s=function(e){function t(t,n){var o=e.call(this,t)||this;return o.code=n.code,o.msg=n.msg,o}return o(t,e),t.eventName="PubsErrorEvent",t}(r),a=function(e){this.msg="",this.code=e.code,e.msg&&(this.msg=e.msg)};n.d(t,"Pubs",function(){return f});
/*!
 * Copyright 2018 Kopano
 *
 * Use of this source code is governed by a MIT license
 * that can be found in the LICENSE.txt file.
 *
 * @author   Kopano <https://kopano.com>
 * @license  MIT
 * @preserve
 */
var u=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},h=function(e,t,n,o){return new(n||(n=Promise))(function(r,c){function i(e){try{a(o.next(e))}catch(e){c(e)}}function s(e){try{a(o.throw(e))}catch(e){c(e)}}function a(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(i,s)}a((o=o.apply(e,t||[])).next())})},l=function(e,t){var n,o,r,c,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return c={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function s(c){return function(s){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,o=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!(r=(r=i.trys).length>0&&r[r.length-1])&&(6===c[0]||2===c[0])){i=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){i.label=c[1];break}if(6===c[0]&&i.label<r[1]){i.label=r[1],r=c;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(c);break}r[2]&&i.ops.pop(),i.trys.pop();continue}c=t.call(e,i)}catch(e){c=[6,e],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}},d={authorizationType:"Bearer",authorizationValue:"",connectTimeout:5e3,heartbeatInterval:5e3,maxReconnectInterval:3e4,reconnectEnabled:!0,reconnectFactor:1.5,reconnectInterval:1e3,reconnectSpreader:500,streamAckTimeout:2e4},p=0,f=function(){function e(t,n){void 0===t&&(t=""),this.connecting=!1,this.connected=!1,this.reconnecting=!1,this.closing=!1,this.reconnector=0,this.reconnectAttempts=0,this.baseURI=t.replace(/\/$/,""),this.options=u({},d,e.defaultOptions,n),this.replyHandlers=new Map}return e.init=function(e){this.defaultOptions=u({},d,e)},e.prototype.connect=function(){return h(this,void 0,void 0,function(){var e,t=this;return l(this,function(n){return console.debug("pubs: connect"),clearTimeout(this.reconnector),e=function(e){if(void 0===e&&(e=!1),clearTimeout(t.reconnector),t.reconnecting){var n=t.options.reconnectInterval;e||((n*=Math.trunc(Math.pow(t.options.reconnectFactor,t.reconnectAttempts)))>t.options.maxReconnectInterval&&(n=t.options.maxReconnectInterval),n+=Math.floor(Math.random()*t.options.reconnectSpreader)),t.reconnector=window.setTimeout(function(){t.connect()},n),t.reconnectAttempts++}},this.reconnecting=this.options.reconnectEnabled||!0,this.connecting=!0,this.dispatchStateChangedEvent(),[2,new Promise(function(n,o){return h(t,void 0,void 0,function(){var t,r,c,i,s=this;return l(this,function(u){switch(u.label){case 0:r="",this.options.authorizationType&&this.options.authorizationValue&&(r=this.options.authorizationType+" "+this.options.authorizationValue),u.label=1;case 1:return u.trys.push([1,3,,4]),[4,this.fetchStreamWebSocketConnect(r)];case 2:return t=u.sent(),[3,4];case 3:return c=u.sent(),console.warn("pubs: failed to fetch websocket connection details",c),t={error:{code:"request_failed",msg:""+c},streamUrl:""},[3,4];case 4:return console.debug("connect result",t),t.streamUrl?((i=t.streamUrl).includes("://")||(i=this.baseURI+i),this.connectStreamWebSocket(i,this.reconnecting?e:void 0).then(function(){s.reconnectAttempts=0,console.debug("pubs: connection established",s.reconnectAttempts),n()},function(t){console.warn("pubs: connection failed",t,!!s.reconnecting),s.reconnecting?e():o(t)}),[2]):(this.connecting=!1,this.dispatchStateChangedEvent(),this.reconnecting?(t.error&&"http_error_403"===t.error.code&&(console.warn("pubs: giving up reconnect, as connect returned forbidden",t.error.msg),this.reconnecting=!1,this.dispatchStateChangedEvent(),this.dispatchErrorEvent(t.error)),e()):t.error?o(new a(t.error)):o(new a({code:"unknown_error",msg:""})),[2])}})})})]})})},e.prototype.sub=function(e){return h(this,void 0,void 0,function(){return l(this,function(t){return[2,this.pubsub("sub",e)]})})},e.prototype.sendStreamWebSocketPayload=function(e,t){return void 0===t&&(t=0),h(this,void 0,void 0,function(){var n=this;return l(this,function(o){return 0===t&&(t=this.options.streamAckTimeout),[2,new Promise(function(o,r){if(n.connected&&n.socket&&!n.closing){e.state=String(++p);try{n.socket.send(JSON.stringify(e))}catch(e){return void r(e)}if(t>0){var c=window.setTimeout(function(){r(new Error("timeout"))},t);n.replyHandlers.set(e.state,{resolve:o,timeout:c})}else setTimeout(o,0)}else r(new Error("no_connection"))})]})})},e.prototype.unsub=function(e){return h(this,void 0,void 0,function(){return l(this,function(t){return[2,this.pubsub("unsub",e)]})})},e.prototype.pubsub=function(e,t){return h(this,void 0,void 0,function(){var n;return l(this,function(o){return n={info:{topics:t},state:"",type:e},[2,this.sendStreamWebSocketPayload(n).then(function(){console.log("pubs: send done")})]})})},e.prototype.fetchStreamWebSocketConnect=function(e){return h(this,void 0,void 0,function(){var t,n;return l(this,function(o){return t=this.baseURI+"/api/pubs/v1/stream/connect",n=new Headers,e&&n.set("Authorization",e),[2,fetch(t,{headers:n,method:"POST",mode:"cors"}).then(function(e){return e.ok?e.json():{error:{code:"http_error_"+e.status,msg:e.statusText}}})]})})},e.prototype.connectStreamWebSocket=function(e,t){return h(this,void 0,void 0,function(){var n=this;return l(this,function(o){return console.debug("pubs: connect stream websocket",e),[2,new Promise(function(o,r){if(n.socket){console.warn("pubs: closing existing socket connection");var c=n.socket;n.socket=void 0,n.connected=!1,n.closeStreamWebsocket(c)}var i=function(e){var t=document.createElement("a");return t.href=e,t.href}(e).replace(/^https:\/\//i,"wss://").replace(/^http:\/\//i,"ws://");console.debug("pubs: connecting stream socket URL",i);var s=new WebSocket(i+"?v=1"),a=!1,u=setTimeout(function(){a=!0,s===n.socket&&(n.socket=void 0,n.connected=!1,n.connecting=!1,n.dispatchStateChangedEvent()),setTimeout(function(){n.closeStreamWebsocket(s)},0),r(new Error("connect_timeout"))},n.options.connectTimeout);s.onopen=function(e){clearTimeout(u),a||(e.target===n.socket?(console.debug("pubs: stream socket connected",e),n.connected=!0,n.connecting=!1,n.dispatchStateChangedEvent(),n.socket.onmessage=n.handleStreamWebSocketMessage.bind(n),o(e.target)):n.closeStreamWebsocket(e.target))},s.onclose=function(e){clearTimeout(u),a||(e.target===n.socket?(console.debug("pubs: socket closed",e),n.socket=void 0,n.closing=!1,n.connected=!1,n.connecting=!1,n.dispatchStateChangedEvent(),t&&t()):n.socket||n.connecting||!t||(console.debug("pubs: socket closed, retry immediate reconnect now",e),t(!0)))},s.onerror=function(e){clearTimeout(u),a||(setTimeout(function(){r(e)},0),e.target===n.socket&&(console.debug("pubs: socket error",e),n.socket=void 0,n.connected=!1,n.connecting=!1,n.dispatchErrorEvent({code:"websocket_error",msg:""+e}),n.dispatchStateChangedEvent()))},n.closing=!1,n.socket=s})]})})},e.prototype.closeStreamWebsocket=function(e){e===this.socket&&(this.closing=!0),e.close()},e.prototype.handleStreamWebSocketMessage=function(e){if(e.target===this.socket){var t=JSON.parse(e.data);switch(t.type){case"hello":console.debug("pubs: server hello",t);break;case"goodbye":console.debug("pubs: server goodbye, close connection",t),this.reconnectAttempts=1,this.closeStreamWebsocket(this.socket),this.connected=!1;break;case"ack":var n=this.replyHandlers.get(t.state);n?(this.replyHandlers.delete(t.state),clearTimeout(n.timeout),n.resolve(t)):console.log("received ack without handler",t);break;case"event":this.dispatchStreamEvent(t.data,t.info);break;default:console.debug("pubs: unknown type",t.type,t)}}else e.target.close()},e.prototype.dispatchEvent=function(e){switch(e.constructor.getName()){case c.getName():this.onstatechanged&&this.onstatechanged(e);break;case i.getName():this.onstreamevent&&this.onstreamevent(e);break;case s.getName():this.onerror&&this.onerror(e);break;default:throw new Error("unknown event: "+e.constructor.getName())}},e.prototype.dispatchStateChangedEvent=function(){this.dispatchEvent(new c(this))},e.prototype.dispatchStreamEvent=function(e,t){this.dispatchEvent(new i(this,e,t))},e.prototype.dispatchErrorEvent=function(e){this.dispatchEvent(new s(this,e))},e.version="0.2.0",e}()},function(e,t,n){e.exports=n(0)}]).Pubs});
//# sourceMappingURL=pubs.js.map