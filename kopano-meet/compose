version: "2.0"

services:
  web:
    image: fbartels/kopano_web:0.9.1
    container_name: kopano_web
    restart: always
    ports:
      - "2015:2015"
    environment:
      - DEFAULTREDIRECT=/meet
      - EMAIL=off
      - FQDN=${FQDN_MEET}
      - KONNECTPATH=meetid
    command: wrapper.sh
    volumes:
     - /etc/machine-id:/etc/machine-id
     - /etc/ssl/certs:/etc/ssl/certs:ro
     - /etc/machine-id:/var/lib/dbus/machine-id
    networks:
     - web-net

  kopano_ssl:
    image: fbartels/kopano_ssl:1.2.0
    container_name: kopano_ssl
    environment:
      - FQDN=${FQDN_MEET}
      - PKI_COUNTRY=DE
    volumes:
      - /etc/kopano/docker/:/kopano/ssl

  kopano_konnect:
    image: fbartels/kopano_konnect:0.33.0
    container_name: kopano_konnect
    restart: always
    depends_on:
      - kopano_ssl
      - web
    volumes:
      - /etc/kopano/docker/:/kopano/ssl
      - /etc/machine-id:/etc/machine-id
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /etc/machine-id:/var/lib/dbus/machine-id
      - /var/lib/univention-appcenter/apps/kopano-meet/machine.secret:/etc/machine.secret
    environment:
      - allow_client_guests=${MEET_GUEST_ALLOW}
      - eckey=/kopano/ssl/meet-kwmserver.pem
      - ecparam=/kopano/ssl/ecparam.pem
      - encryption_secret_key=/kopano/ssl/konnectd-encryption.key
      - external_oidc_clientsecret=${clientsecret}
      - external_oidc_name=ucs-konnect
      - external_oidc_provider=yes
      - external_oidc_url=https://${FQDN_SSO}
      - FQDN=${FQDN_MEET}/meetid
      - identifier_registration_conf=/kopano/ssl/konnectd-identifier-registration.yaml
      - identifier_scopes_conf=/etc/kopano/konnectd-identifier-scopes.yaml
      - insecure=${INSECURE}
      - KONNECT_BACKEND=ldap
      - LDAP_BASEDN=@%@ldap/base@%@
      - LDAP_BINDDN=@%@appcenter/apps/kopano-meet/hostdn@%@
      - LDAP_BINDPW_FILE=/etc/machine.secret
      - LDAP_EMAIL_ATTRIBUTE=mail
      - LDAP_FILTER=(objectClass=organizationalPerson)
      - LDAP_LOGIN_ATTRIBUTE=uid
      - LDAP_NAME_ATTRIBUTE=cn
      - LDAP_SCOPE=sub
      - LDAP_URI=ldap://@%@ldap/server/name@%@:@%@ldap/server/port@%@
      - LDAP_UUID_ATTRIBUTE_TYPE=text
      - LDAP_UUID_ATTRIBUTE=uidNumber
      - signing_private_key=/kopano/ssl/konnectd-tokens-signing-key.pem
      - uri_base_path=/meetid
    networks:
      - kopano-net
      - web-net

  kopano_grapi:
    image: fbartels/kopano_core:8.7.85.0.f3999a9
    container_name: kopano_grapi
    restart: always
    volumes:
      - /etc/machine-id:/etc/machine-id
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /run/kopano:/run/kopano
      - /etc/machine-id:/var/lib/dbus/machine-id
      - /var/lib/kopano-grapi:/var/lib/kopano-grapi
      - /var/lib/univention-appcenter/apps/kopano-meet/machine.secret:/etc/machine.secret
    environment:
      - GRAPI_BACKEND=ldap
      - KCCONF_GRAPI_LDAP_BASEDN=@%@ldap/base@%@
      - KCCONF_GRAPI_LDAP_BINDDN=@%@appcenter/apps/kopano-meet/hostdn@%@
      - KCCONF_GRAPI_LDAP_BINDPW_FILE=/etc/machine.secret
      - KCCONF_GRAPI_LDAP_URI=ldap://@%@ldap/server/name@%@:@%@ldap/server/port@%@
      - KCCONF_GRAPI_PERSISTENCY_PATH=/var/lib/kopano-grapi
      #- LDAP_FILTER=(objectClass=organizationalPerson) # TODO identify attribute to filter on to avoid join users showing up in the gab
      - SERVICE_TO_START=grapi
      - TZ=Europe/Berlin
    networks:
      - kopano-net

  kopano_kapi:
    image: fbartels/kopano_core:8.7.85.0.f3999a9
    container_name: kopano_kapi
    restart: always
    depends_on:
      - kopano_grapi
    volumes:
      - /etc/kopano/docker/:/kopano/ssl
      - /etc/machine-id:/etc/machine-id
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /run/kopano:/run/kopano
      - /etc/machine-id:/var/lib/dbus/machine-id
      - /var/lib/kopano/kapi-kvs/:/kopano/data/kapi-kvs/
    environment:
      - DEFAULT_PLUGIN_PUBS_SECRET_KEY_FILE=/kopano/ssl/kapid-pubs-secret.key
      - KCCONF_KAPID_INSECURE=${INSECURE}
      - KCCONF_KAPID_LISTEN=0.0.0.0:8039
      - KCCONF_KAPID_LOG_LEVEL=DEBUG
      - KCCONF_KAPID_OIDC_ISSUER_IDENTIFIER=https://${FQDN_MEET}/meetid
      - KCCONF_KAPID_PLUGIN_GRAPI_SOCKET_PATH=/var/run/kopano/grapi
      - KCCONF_KAPID_PLUGIN_KVS_DB_DATASOURCE=/kopano/data/kapi-kvs/kvs.db
      - SERVICE_TO_START=kapi
      - TZ=Europe/Berlin
    networks:
      - kopano-net
      - web-net

  kopano_kwmserver:
    image: fbartels/kopano_kwmserver:1.1.1
    container_name: kopano_kwmserver
    restart: always
    command: wrapper.sh
    environment:
     - enable_guest_api=${MEET_GUEST_ALLOW}
     - INSECURE=${INSECURE}
     - oidc_issuer_identifier=https://${FQDN_MEET}/meetid
     - public_guest_access_regexp=${MEET_GUEST_REGEXP}
     - registration_conf=/kopano/ssl/konnectd-identifier-registration.yaml
     - turn_service_credentials_password=${TURN_PASSWORD}
     - turn_service_credentials_user=${TURN_USER}
     - turn_service_url=${TURN_SERVICE_URL}
     - turn_uris=${TURN_URIS}
     - turn_server_shared_secret=${TURN_SERVER_SHARED_SECRET}
    volumes:
      - /etc/kopano/docker/:/kopano/ssl
      - /etc/machine-id:/etc/machine-id
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /etc/machine-id:/var/lib/dbus/machine-id
    networks:
     - web-net

  kopano_meet:
    image: fbartels/kopano_meet:2.1.0_0
    container_name: kopano_meet
    restart: always
    environment:
     - GRID_KONNECT=no
     - GRID_WEBAPP=${GRID_WEBAPP}
     - KCCONF_KWEBD_TLS=no
     - KCCONF_MEET_disableFullGAB=false
     - KCCONF_MEET_guests_enabled=${MEET_GUEST_BOOLALLOW}
     - KCCONF_MEET_oidc_iss=https://${FQDN_MEET}/meetid
     - KCCONF_MEET_useIdentifiedUser=true
     - SERVICE_TO_START=meet
    volumes:
     - /etc/machine-id:/etc/machine-id
     - /etc/ssl/certs:/etc/ssl/certs:ro
     - /etc/machine-id:/var/lib/dbus/machine-id
    depends_on:
     - kopano_kapi
     - kopano_kwmserver
     - web
    networks:
     - web-net

networks:
  web-net:
  kopano-net:
    driver: bridge
