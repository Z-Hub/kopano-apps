#!/bin/bash

eval "$(ucr shell)"

update_env_file () {
    varname="$1"
    varvalue="$2"
    if ! grep -q "$varname" ./.env; then
        echo "$varname=$varvalue" >> ./.env
    else
        sed -i "/$varname/c $varname=$varvalue" ./.env
    fi
}

cd /var/lib/univention-appcenter/apps/kopano-meet/compose
touch .env

# ensure read permissions for konnect container
chmod go+r /var/lib/univention-appcenter/apps/kopano-meet/machine.secret

# ask if running with self signed (untrusted) certificates
update_env_file INSECURE $(ucr get kopano/docker/INSECURE)

update_env_file GRID_WEBAPP $(ucr get kopano/docker/GRID_WEBAPP)

update_env_file TURN_USER $(ucr get kopano/docker/TURN_USER)
update_env_file TURN_PASSWORD $(ucr get kopano/docker/TURN_PASSWORD)

update_env_file MEET_GUEST_ALLOW $(ucr get kopano/docker/MEET_GUEST_ALLOW)

if [ $(ucr get kopano/docker/MEET_GUEST_ALLOW) = "yes" ]; then
	update_env_file MEET_GUEST_BOOLALLOW true
else
	update_env_file MEET_GUEST_BOOLALLOW false
fi

update_env_file MEET_GUEST_REGEXP $(ucr get kopano/docker/MEET_GUEST_REGEXP)

if [ "$1" = "settings" ]; then
    docker-compose up -d
fi
